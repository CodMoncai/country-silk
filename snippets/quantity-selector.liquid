{%- doc -%}
  This snippet is used to render the quantity selector for a product.
  It is used in the product page, the cart page and the quick order list.

  @param {object} product - the product to render the quantity selector for
  @param {object} [variant] - the specific variant to use (for cart items), if not provided uses selected_or_first_available_variant
  @param {number} [in_cart_quantity] - the quantity in the cart to set the input value
  @param {number} [line_index] - the index of the forloop representing the line on which the quantity selector is rendered
  @param {string} [class] - custom class for the quantity selector, optional
  @param {boolean} [can_update_quantity] - whether the quantity can be updated, defaults to true
  @param {number} [min] - override the minimum quantity (e.g., 0 for quick order list)
{%- enddoc -%}

{% liquid
  if variant
    assign variant = variant
  else
    assign variant = product.selected_or_first_available_variant
  endif
  assign component_name = 'quantity-selector-component'
  if line_index != null
    assign component_name = 'cart-quantity-selector-component'
  endif

  if min != null
    assign min_quantity = min
  else
    assign min_quantity = variant.quantity_rule.min | default: 1
  endif

  assign case_pack = nil
  assign max_case_quantity = nil
  assign initial_case = 1
  assign initial_total = min_quantity
  if line_index == null
    assign case_pack = variant.metafields.custom.case_pack.value | default: product.metafields.custom.case_pack.value
    if case_pack != blank and case_pack > 0
      assign min_total = variant.quantity_rule.min | default: 1
      assign initial_case = min_total | plus: case_pack | minus: 1 | divided_by: case_pack
      if initial_case < 1
        assign initial_case = 1
      endif
      assign initial_total = initial_case | times: case_pack
      if variant.inventory_management == 'shopify' and variant.inventory_quantity > 0
        assign max_case_quantity = variant.inventory_quantity | divided_by: case_pack
      elsif variant.quantity_rule.max != null
        assign max_case_quantity = variant.quantity_rule.max | divided_by: case_pack
      endif
      if max_case_quantity != null and max_case_quantity < 1
        assign max_case_quantity = 1
      endif
    endif
  endif
%}

<div
  class="quantity-selector-wrapper"
  ref="quantitySelectorWrapper"
>
  <{{ component_name }}
    class="quantity-selector{% if class %} {{ class }}{% endif %}{% if case_pack != blank and case_pack > 0 %} quantity-selector--case-pack{% endif %}"
    data-variant-id="{{ variant.id }}"
    {% if case_pack != blank and case_pack > 0 %}
      data-case-pack="{{ case_pack }}"
      {% if max_case_quantity != nil %}data-max-case-quantity="{{ max_case_quantity }}"{% endif %}
    {% endif %}
    {% if line_index == null %}
      {{- block.shopify_attributes -}}
      ref="quantitySelector"
    {% else %}
      ref="quantitySelectors[]"
    {% endif %}
  >
    {%- if case_pack != blank and case_pack > 0 -%}
      <span class="quantity-selector__label quantity-selector__label--case caption-large">{{ 'products.product.case_quantity_label' | t }}</span>
      <button
        class="button quantity-minus button-unstyled quantity-selector__case-minus"
        type="button"
        aria-label="{{ 'accessibility.decrease_quantity' | t }}"
        on:click="/decreaseCaseQuantity"
        ref="caseMinusButton"
      >
        <span class="svg-wrapper icon-plus">{{- 'icon-minus.svg' | inline_asset_content -}}</span>
      </button>
      <input
        type="number"
        class="quantity-selector__case-input"
        min="1"
        {% if max_case_quantity != nil %}max="{{ max_case_quantity }}"{% endif %}
        value="{{ initial_case }}"
        ref="caseQuantityInput"
        aria-label="{{ 'accessibility.case_quantity' | t }}"
        on:blur="/setCaseQuantity"
      >
      <button
        class="button quantity-plus button-unstyled quantity-selector__case-plus"
        type="button"
        aria-label="{{ 'accessibility.increase_quantity' | t }}"
        on:click="/increaseCaseQuantity"
        ref="casePlusButton"
      >
        <span class="svg-wrapper icon-plus">{{- 'icon-plus.svg' | inline_asset_content -}}</span>
      </button>
    {%- endif -%}

    <button
      class="button quantity-minus button-unstyled{% if case_pack != blank and case_pack > 0 %} visually-hidden{% endif %}"
      type="button"
      name="minus"
      on:click="/decreaseQuantity"
      ref="minusButton"
      {% if case_pack != blank and case_pack > 0 %}disabled aria-hidden="true"{% elsif can_update_quantity == false %}disabled{% endif %}
    >
      <span class="visually-hidden">{{ 'accessibility.decrease_quantity' | t }}</span
      ><span class="svg-wrapper icon-plus">
        {{- 'icon-minus.svg' | inline_asset_content -}}
      </span>
    </button>
    <input
      type="number"
      name="{% if line_index %}updates[]{% else %}quantity{% endif %}"
      value="{% if case_pack != blank and case_pack > 0 %}{{ initial_total }}{% else %}{{ in_cart_quantity | default: variant.quantity_rule.min | default: 1 }}{% endif %}"
      data-cart-quantity="{{ cart | item_count_for_variant: variant.id }}"
      min="{% if case_pack != blank and case_pack > 0 %}{{ case_pack }}{% else %}{{ min_quantity }}{% endif %}"
      data-min="{{ variant.quantity_rule.min | default: 1 }}"
      {% if case_pack != blank and case_pack > 0 and max_case_quantity != nil %}max="{{ max_case_quantity | times: case_pack }}"{% elsif variant.quantity_rule.max %}max="{{ variant.quantity_rule.max }}"{% endif %}
      {% if case_pack != blank and case_pack > 0 %}readonly{% else %}on:blur="/setQuantity"
      on:focus="/selectInputValue"{% endif %}
      ref="quantityInput"
      aria-label="{% if case_pack != blank and case_pack > 0 %}{{ 'accessibility.total_items' | t }}{% else %}{{ 'accessibility.quantity' | t }}{% endif %}"
      {% if line_index %}
        data-cart-line="{{ line_index | plus: 1 }}"
      {% endif %}
      {% if variant.quantity_rule.max %}
        max="{{ variant.quantity_rule.max }}"
      {% endif %}
      step="{% if case_pack != blank and case_pack > 0 %}{{ case_pack }}{% else %}{{ variant.quantity_rule.increment | default: 1 }}{% endif %}"
      {% if can_update_quantity == false or variant.available == false %}
        disabled
      {% endif %}
    >
    <button
      class="button quantity-plus button-unstyled{% if case_pack != blank and case_pack > 0 %} visually-hidden{% endif %}"
      type="button"
      name="plus"
      on:click="/increaseQuantity"
      ref="plusButton"
      {% if case_pack != blank and case_pack > 0 %}disabled aria-hidden="true"{% elsif can_update_quantity == false %}disabled{% endif %}
    >
      <span class="visually-hidden">{{ 'accessibility.increase_quantity' | t }}</span
      ><span class="svg-wrapper icon-plus">
        {{- 'icon-plus.svg' | inline_asset_content -}}
      </span>
    </button>
    {%- if case_pack != blank and case_pack > 0 -%}
      <span class="quantity-selector__label quantity-selector__label--total caption-large">{{ 'products.product.total_items_label' | t }}</span>
    {%- endif -%}
  </{{ component_name }}>

  {%- if line_index == null -%}
    {%- liquid
      # Check if variant has volume pricing
      assign has_volume_pricing = false
      if product.quantity_price_breaks_configured? and variant.quantity_price_breaks.size > 0
        assign has_volume_pricing = true
      endif
    -%}

    {%- if has_volume_pricing -%}
      {%- # Case: Volume pricing exists - show "at price / ea" -%}
      {%- liquid
        # Determine if currency code should be shown on product pages
        assign use_currency = settings.currency_code_enabled_product_pages
      -%}
      {%- capture price_breaks_json -%}
        [{%- for price_break in variant.quantity_price_breaks -%}{%- unless forloop.first -%},{%- endunless -%}{%- if use_currency -%}{"quantity":{{ price_break.minimum_quantity }},"price":{{ price_break.price | money_with_currency | json }}}{%- else -%}{"quantity":{{ price_break.minimum_quantity }},"price":{{ price_break.price | money | json }}}{%- endif -%}{%- endfor -%}]
      {%- endcapture -%}

      {%- liquid
        # Calculate initial display price
        assign cart_qty = cart | item_count_for_variant: variant.id
        assign current_qty = cart_qty | plus: variant.quantity_rule.min
        if cart_qty > 0
          assign current_qty = cart_qty | plus: variant.quantity_rule.increment
        endif

        assign display_price = variant.price
        for price_break in variant.quantity_price_breaks
          if current_qty >= price_break.minimum_quantity
            assign display_price = price_break.price
            break
          endif
        endfor
      -%}

      <price-per-item
        class="price-per-item"
        data-variant-id="{{ variant.id }}"
        data-variant-price="{%- if use_currency -%}{{ variant.price | money_with_currency | escape }}{%- else -%}{{ variant.price | money | escape }}{%- endif -%}"
        data-min-quantity="{{ variant.quantity_rule.min | default: 1 }}"
        data-price-breaks="{{ price_breaks_json | strip | escape }}"
        data-at-text="{{ 'content.price_at' | t | escape }}"
        data-each-text="{{ 'content.each_abbreviation' | t | escape }}"
        ref="pricePerItem"
      >
        <span
          class="price-per-item__text"
          ref="pricePerItemText"
        >
          {{- 'content.price_at' | t }}
          {%- if use_currency -%}
            {{- display_price | money_with_currency -}}
          {%- else -%}
            {{- display_price | money -}}
          {%- endif -%}
          /
          {{- 'content.each_abbreviation' | t }}
        </span>
      </price-per-item>
    {%- endif -%}
  {%- endif -%}
</div>

{% stylesheet %}
  .quantity-selector-wrapper {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: calc(var(--gap-sm) / 2);

    @media screen and (min-width: 750px) {
      gap: var(--gap-sm);
    }
  }

  .quantity-selector--case-pack {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: calc(var(--gap-sm) / 2);

    @media screen and (min-width: 750px) {
      gap: var(--gap-sm);
    }
  }

  .quantity-selector__label {
    flex: 0 0 auto;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  .quantity-selector__case-input {
    width: 3.5rem;
    text-align: center;
    -moz-appearance: textfield;
  }

  .quantity-selector__case-input::-webkit-outer-spin-button,
  .quantity-selector__case-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .quantity-selector--case-pack .quantity-selector__label--total {
    margin-inline-start: var(--gap-sm);
  }
{% endstylesheet %}
