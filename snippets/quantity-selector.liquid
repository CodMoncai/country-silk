{%- doc -%}
  This snippet is used to render the quantity selector for a product.
  It is used in the product page, the cart page and the quick order list.

  @param {object} product - the product to render the quantity selector for
  @param {object} [variant] - the specific variant to use (for cart items), if not provided uses selected_or_first_available_variant
  @param {number} [in_cart_quantity] - the quantity in the cart to set the input value
  @param {number} [line_index] - the index of the forloop representing the line on which the quantity selector is rendered
  @param {string} [class] - custom class for the quantity selector, optional
  @param {boolean} [can_update_quantity] - whether the quantity can be updated, defaults to true
  @param {number} [min] - override the minimum quantity (e.g., 0 for quick order list)
{%- enddoc -%}

{% liquid
  if variant
    assign variant = variant
  else
    assign variant = product.selected_or_first_available_variant
  endif
  assign component_name = 'quantity-selector-component'
  if line_index != null
    assign component_name = 'cart-quantity-selector-component'
  endif

  if min != null
    assign min_quantity = min
  else
    assign min_quantity = variant.quantity_rule.min | default: 1
  endif

  assign case_pack = nil
  assign max_case_quantity = nil
  assign initial_case = 1
  assign initial_total = min_quantity
  if line_index == null
    assign case_pack = variant.metafields.custom.case_pack.value | default: product.metafields.custom.case_pack.value
    if case_pack != blank and case_pack > 0
      assign min_total = variant.quantity_rule.min | default: 1
      assign initial_case = min_total | plus: case_pack | minus: 1 | divided_by: case_pack
      if initial_case < 1
        assign initial_case = 1
      endif
      assign initial_total = initial_case | times: case_pack
      if variant.inventory_management == 'shopify' and variant.inventory_quantity > 0
        assign max_case_quantity = variant.inventory_quantity | divided_by: case_pack
      elsif variant.quantity_rule.max != null
        assign max_case_quantity = variant.quantity_rule.max | divided_by: case_pack
      endif
      if max_case_quantity != null and max_case_quantity < 1
        assign max_case_quantity = 1
      endif
    endif
  endif
%}

<div
  class="quantity-selector-wrapper"
  ref="quantitySelectorWrapper"
>
  <{{ component_name }}
    class="quantity-selector{% if class %} {{ class }}{% endif %}{% if case_pack != blank and case_pack > 0 %} quantity-selector--case-pack{% endif %}"
    data-variant-id="{{ variant.id }}"
    {% if case_pack != blank and case_pack > 0 %}
      data-case-pack="{{ case_pack }}"
      {% if max_case_quantity != nil %}data-max-case-quantity="{{ max_case_quantity }}"{% endif %}
    {% endif %}
    {% if line_index == null %}
      {{- block.shopify_attributes -}}
      ref="quantitySelector"
    {% else %}
      ref="quantitySelectors[]"
    {% endif %}
  >
    {%- if case_pack != blank and case_pack > 0 -%}
      <div class="quantity-selector__group quantity-selector__group--case">
        <span class="quantity-selector__label quantity-selector__label--case caption-large" id="quantity-selector-case-label-{{ variant.id }}">{{ 'products.product.case_quantity_label' | t }}</span>
        <div class="quantity-selector__input-row">
          <button
            class="button quantity-minus button-unstyled quantity-selector__case-minus"
            type="button"
            aria-label="{{ 'accessibility.decrease_quantity' | t }}"
            on:click="/decreaseCaseQuantity"
            ref="caseMinusButton"
          >
            <span class="svg-wrapper icon-plus">{{- 'icon-minus.svg' | inline_asset_content -}}</span>
          </button>
          <input
            type="number"
            class="quantity-selector__case-input quantity-selector__input-box"
            min="1"
            {% if max_case_quantity != nil %}max="{{ max_case_quantity }}"{% endif %}
            value="{{ initial_case }}"
            ref="caseQuantityInput"
            aria-labelledby="quantity-selector-case-label-{{ variant.id }}"
            on:blur="/setCaseQuantity"
          >
          <button
            class="button quantity-plus button-unstyled quantity-selector__case-plus"
            type="button"
            aria-label="{{ 'accessibility.increase_quantity' | t }}"
            on:click="/increaseCaseQuantity"
            ref="casePlusButton"
          >
            <span class="svg-wrapper icon-plus">{{- 'icon-plus.svg' | inline_asset_content -}}</span>
          </button>
        </div>
      </div>
      <div class="quantity-selector__group quantity-selector__group--total">
        <span class="quantity-selector__label quantity-selector__label--total caption-large" id="quantity-selector-total-label-{{ variant.id }}">{{ 'products.product.total_items_label' | t }}</span>
        <div class="quantity-selector__input-row quantity-selector__input-row--total">
          <span class="quantity-selector__total-input-wrapper">
            <input
              type="number"
              name="{% if line_index %}updates[]{% else %}quantity{% endif %}"
              value="{{ initial_total }}"
              data-cart-quantity="{{ cart | item_count_for_variant: variant.id }}"
              min="{{ case_pack }}"
              {% if max_case_quantity != nil %}max="{{ max_case_quantity | times: case_pack }}"{% endif %}
              step="{{ case_pack }}"
              readonly
              ref="quantityInput"
              aria-labelledby="quantity-selector-total-label-{{ variant.id }}"
              class="quantity-selector__input-box quantity-selector__total-input"
              tabindex="-1"
              aria-readonly="true"
            >
          </span>
          <span class="quantity-selector__refs-hidden" aria-hidden="true">
            <button type="button" ref="minusButton" disabled aria-hidden="true">-</button>
            <button type="button" ref="plusButton" disabled aria-hidden="true">+</button>
          </span>
        </div>
      </div>
    {%- else -%}
    <button
      class="button quantity-minus button-unstyled"
      type="button"
      name="minus"
      on:click="/decreaseQuantity"
      ref="minusButton"
      {% if can_update_quantity == false %}disabled{% endif %}
    >
      <span class="visually-hidden">{{ 'accessibility.decrease_quantity' | t }}</span
      ><span class="svg-wrapper icon-plus">
        {{- 'icon-minus.svg' | inline_asset_content -}}
      </span>
    </button>
    <input
      type="number"
      name="{% if line_index %}updates[]{% else %}quantity{% endif %}"
      value="{{ in_cart_quantity | default: variant.quantity_rule.min | default: 1 }}"
      data-cart-quantity="{{ cart | item_count_for_variant: variant.id }}"
      min="{{ min_quantity }}"
      data-min="{{ variant.quantity_rule.min | default: 1 }}"
      on:blur="/setQuantity"
      on:focus="/selectInputValue"
      ref="quantityInput"
      aria-label="{{ 'accessibility.quantity' | t }}"
      {% if line_index %}
        data-cart-line="{{ line_index | plus: 1 }}"
      {% endif %}
      {% if variant.quantity_rule.max %}
        max="{{ variant.quantity_rule.max }}"
      {% endif %}
      step="{{ variant.quantity_rule.increment | default: 1 }}"
      {% if can_update_quantity == false or variant.available == false %}
        disabled
      {% endif %}
    >
    <button
      class="button quantity-plus button-unstyled"
      type="button"
      name="plus"
      on:click="/increaseQuantity"
      ref="plusButton"
      {% if can_update_quantity == false %}disabled{% endif %}
    >
      <span class="visually-hidden">{{ 'accessibility.increase_quantity' | t }}</span
      ><span class="svg-wrapper icon-plus">
        {{- 'icon-plus.svg' | inline_asset_content -}}
      </span>
    </button>
    {%- endif -%}
  </{{ component_name }}>

  {%- if line_index == null -%}
    {%- liquid
      # Check if variant has volume pricing
      assign has_volume_pricing = false
      if product.quantity_price_breaks_configured? and variant.quantity_price_breaks.size > 0
        assign has_volume_pricing = true
      endif
    -%}

    {%- if has_volume_pricing -%}
      {%- # Case: Volume pricing exists - show "at price / ea" -%}
      {%- liquid
        # Determine if currency code should be shown on product pages
        assign use_currency = settings.currency_code_enabled_product_pages
      -%}
      {%- capture price_breaks_json -%}
        [{%- for price_break in variant.quantity_price_breaks -%}{%- unless forloop.first -%},{%- endunless -%}{%- if use_currency -%}{"quantity":{{ price_break.minimum_quantity }},"price":{{ price_break.price | money_with_currency | json }}}{%- else -%}{"quantity":{{ price_break.minimum_quantity }},"price":{{ price_break.price | money | json }}}{%- endif -%}{%- endfor -%}]
      {%- endcapture -%}

      {%- liquid
        # Calculate initial display price
        assign cart_qty = cart | item_count_for_variant: variant.id
        assign current_qty = cart_qty | plus: variant.quantity_rule.min
        if cart_qty > 0
          assign current_qty = cart_qty | plus: variant.quantity_rule.increment
        endif

        assign display_price = variant.price
        for price_break in variant.quantity_price_breaks
          if current_qty >= price_break.minimum_quantity
            assign display_price = price_break.price
            break
          endif
        endfor
      -%}

      <price-per-item
        class="price-per-item"
        data-variant-id="{{ variant.id }}"
        data-variant-price="{%- if use_currency -%}{{ variant.price | money_with_currency | escape }}{%- else -%}{{ variant.price | money | escape }}{%- endif -%}"
        data-min-quantity="{{ variant.quantity_rule.min | default: 1 }}"
        data-price-breaks="{{ price_breaks_json | strip | escape }}"
        data-at-text="{{ 'content.price_at' | t | escape }}"
        data-each-text="{{ 'content.each_abbreviation' | t | escape }}"
        ref="pricePerItem"
      >
        <span
          class="price-per-item__text"
          ref="pricePerItemText"
        >
          {{- 'content.price_at' | t }}
          {%- if use_currency -%}
            {{- display_price | money_with_currency -}}
          {%- else -%}
            {{- display_price | money -}}
          {%- endif -%}
          /
          {{- 'content.each_abbreviation' | t }}
        </span>
      </price-per-item>
    {%- endif -%}
  {%- endif -%}
</div>

{% stylesheet %}
  .quantity-selector-wrapper {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: calc(var(--gap-sm) / 2);

    @media screen and (min-width: 750px) {
      gap: var(--gap-sm);
    }
  }

  /* Case pack: two separate groups in one row, opposite sides */
  .quantity-selector--case-pack {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    justify-content: space-between;
    flex-wrap: nowrap;
    gap: var(--gap-md);
    width: 100%;
  }

  .quantity-selector__group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: var(--gap-2xs);
    min-width: 0;
  }

  .quantity-selector__group--case {
    flex: 0 0 auto;
  }

  .quantity-selector__group--total {
    flex: 0 1 auto;
    min-width: 0;
  }

  .quantity-selector__label {
    flex: 0 0 auto;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
    white-space: nowrap;
  }

  .quantity-selector__input-row {
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0;
    border: var(--style-border-width) solid var(--color-border);
    border-radius: var(--style-border-radius);
    background: rgb(var(--color-background));
    min-height: var(--height-buy-buttons, 4.4rem);
  }

  /* Hide ref-only buttons so they don't take space or cover inputs */
  .quantity-selector__refs-hidden {
    position: absolute;
    width: 0;
    height: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
    pointer-events: none;
  }

  .quantity-selector__input-box {
    display: block;
    width: 3.5rem;
    min-width: 3.5rem;
    padding: var(--padding-sm) var(--padding-2xs);
    text-align: center;
    font: inherit;
    -moz-appearance: textfield;
    border: none;
    background: transparent;
  }

  .quantity-selector__case-input.quantity-selector__input-box {
    border-inline: none;
  }

  .quantity-selector__input-box::-webkit-outer-spin-button,
  .quantity-selector__input-box::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .quantity-selector__total-input-wrapper {
    display: flex;
    align-items: center;
    min-height: 100%;
  }

  .quantity-selector__total-input.quantity-selector__input-box {
    width: 4rem;
    min-width: 4rem;
    cursor: default;
  }

  .quantity-selector__input-row--total {
    padding-inline: var(--padding-sm);
  }

  .quantity-selector__input-row--total .quantity-selector__total-input-wrapper {
    flex: 1 1 auto;
  }
{% endstylesheet %}
